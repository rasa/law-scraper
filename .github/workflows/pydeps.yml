---
# $schema https://json.schemastore.org/github-workflow.json
# ~/.github/workflows/pydeps.yaml
# checkov:skip=CKV_GHA_7:The build output cannot be affected by user parameters
#   other than the build entry point and the top-level source location.
#   GitHub Actions workflow_dispatch inputs MUST be empty.

name: pydeps

env:
  DEFAULT_MASK: '**/*requirements*.txt'

'on':
  schedule:
    # run every day at 15:00 UTC (08:00 PDT)
    - cron: '0 15 * * *'
  workflow_call:
    inputs:
      # checkov:skip=CKV_GHA_7
      mask:
        description: 'File mask for requirements*.txt file(s)'
        required: false
        type: string
        default: '**/*requirements*.txt'

  workflow_dispatch:
    inputs:
      # checkov:skip=CKV_GHA_7
      mask:
        description: 'File mask for requirements*.txt file(s)'
        required: false
        type: string
        default: '**/*requirements*.txt'

jobs:
  job:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        # shell: bash -v -x {0}
        shell: bash --noprofile --norc -e -o pipefail {0}
    strategy:
      fail-fast: true
      max-parallel: 1
      # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#choosing-github-hosted-runners
      matrix:
        os:
          - ubuntu-latest # aka ubuntu-22.04
          - windows-latest # aka windows-2022
          # - macos-latest # aka macos-12 (macos-13 in beta)
        python-version:
          - '3.10'
          - '3.11'
    steps:
      - name: USES actions/checkout@v3.5.3
        uses: actions/checkout@v3.5.3
        with:
          fetch-depth: 1

      - name: RUN gather file list
        run: |
          mask="${{ inputs.mask || env.DEFAULT_MASK }}"
          printf "mask=%s\n" "${mask}"
          dir=$(dirname "${mask}")
          base=$(basename "${mask}")
          if [[ "${dir}" == "**" ]]; then
            dir=.
            depth=99
          else
            depth=1
          fi
          mapfile -t < <(find "${dir}" -maxdepth "${depth}" -type f -iname "${base}")
          printf 'Found %d files matching %s:\n' "${#MAPFILE[@]}" '${mask}'
          printf '%s\n' "${MAPFILE[@]}"
          ((${#MAPFILE[@]})) && reqfiles=$(printf '%s\n' "${MAPFILE[@]}" | base64 -w 0)
          printf 'reqfiles=%s\n' "${reqfiles:-}" >> "${GITHUB_ENV}"

      - name: RUN find mis-versioned dups
        if: env.reqfiles > ''
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          cat "${MAPFILE[@]}" | 
            grep -o '^[^#]*' |
            sed -E 's/\s+//g' |
            sort -u |
            sed -E 's/[<>~!]+/=/g' |
            grep '=' |
            cut -d'=' -f 1 |
            sort |
            uniq -d >dups.tmp
          printf "Duplicates found: "
          wc -l < dups.tmp
          if [[ -s dups.tmp ]]; then
            printf "\n"
            cat dups.tmp
            printf "\n"
            sed 's/^/\^/g' dups.tmp | 
              grep -H -f - "${MAPFILE[@]}" | 
              sed "s|^|::notice::|g" <<<"${out}"
          fi
          rm -f dups.tmp
          exit 0

      - name: USES actions/setup-python@v4.7.0
        if: env.reqfiles > ''
        uses: actions/setup-python@v4.7.0
        with:
          python-version: ${{ matrix.python-version }}
          # see https://stackoverflow.com/questions/73789054/reusable-github-action-workflow-with-actions-setup-python-fails-because-it-cant
          # cache: 'pip'
          # cache-dependency-path: '${{ inputs.mask }}'

      - name: RUN pip install --upgrade pip
        if: env.reqfiles > ''
        run:  python -m pip install --upgrade pip

      - name: RUN pip install pipdeptree pipreqs pur
        if: env.reqfiles > ''
        run: python -m pip install pipdeptree pipreqs pur

      - name: RUN sed -E -i.bak -e '/^#/d; /^$/d;' requirements.txt
        if: env.reqfiles > ''
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          for file in "${MAPFILE[@]}"; do
            printf '\n%s:\n' "${file}"
            sed -E -i.bak -e '/^#/d; /^$/d;' "${file}"
            cat "${file}"
          done

      - name: RUN pipreqs --print --diff requirements.txt
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          for file in "${MAPFILE[@]}"; do
            printf '\n%s:\n' "${file}"
            python -m pipreqs.pipreqs --print --diff "${file}" 2>/dev/null
          done

      - name: RUN pur --dry-run --dry-run-changed --no-recursive --requirement requirements.txt
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          for file in "${MAPFILE[@]}"; do
            printf '\n%s: ' "${file}"
            out=$(python -m pur --dry-run --dry-run-changed --no-recursive --requirement "${file}")
            if [[ -z "${out}" ]]; then
              printf 'no changes found\n'
              continue
            fi
            printf 'changes found:\n%s\n' "${out}"
            sed "s|^|::notice::${file}:|g" <<<"${out}" |
              grep -v '==>'
          done

      - name: RUN pur --no-recursive --requirement requirements.txt
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          for file in "${MAPFILE[@]}"; do
              printf '\n%s: ' "${file}"
              out=$(python -m pur --no-recursive --requirement "${file}")
              if grep -q 'All requirements up-to-date' <<<"${out}"; then
                printf 'no changes found\n'
                continue
              fi
              printf 'changes found:\n%s\n' "${out}"
              sed "s|^|::notice::${file}:|g" <<<"${out}" |
                grep -v '==>'
          done

      - name: RUN pip install -r requirements.txt
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          mapfile -t < <(base64 -d <<<"${reqfiles}")
          for file in "${MAPFILE[@]}"; do
            printf '\n%s: ' "${file}"
            python -m pip install -r "${file}"
          done

      - name: RUN pipdeptree --warn silence
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          pipdeptree --warn silence

      - name: RUN pipdeptree --freeze --warn silence | grep -E '^[a-zA-Z0-9\-]+'
        if: env.reqfiles > ''
        continue-on-error: true
        run: |
          pipdeptree --freeze --warn silence | grep -E '^[a-zA-Z0-9\-]+'

# cSpell:ignore MAPFILE, mapfile, noprofile, norc, pipefail, pipreqs, pydeps, pipdeptree, pur

# eof
